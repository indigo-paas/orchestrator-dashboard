{
  "METADATA_SCHEMA": {
    "$schema": "http://json-schema.org/draft/2020-12/schema#",
    "type": "object",
    "properties" : {
        "services" : { 
            "type": "array",
            "items": {
                "$ref": "#/$defs/service"
            },
            "minItems": 1,
            "uniqueItems": true
        }
    },
    "required": ["services"],
    "additionalProperties": false,
    "$defs": {
        "service": { 
            "type": "object",
            "properties": {
                "description": { "type": "string" },
                "metadata": { "$ref": "#/$defs/metadata" },
                "templates": {
                    "type": "array",
                    "items": { "$ref": "#/$defs/template" }
                }
            },
            "required": ["description", "metadata", "templates"],
            "additionalProperties": false
        },
        "metadata": {
            "type": "object",
            "properties": {
                "display_name": { "type": "string" },
                "bookmark_id": { "type": "string" },
                "icon": { "type": "string", "format": "uri" },
                "visibility": {
                    "$ref": "#/$defs/visibility"
                },
                "authorization_required" : {"$ref": "#/$defs/authorization_required" }
            },
            "required": ["display_name", "bookmark_id", "icon", "visibility"],
            "additionalProperties": false
        },
        "visibility": {
            "type": "object",
            "oneOf": [
              {
                  "type": "object",
                  "properties": {
                    "type": { "type": "string" },
                    "groups": { "type": "array", "items": { "type": "string" } }
                  },
                  "required": ["type", "groups"],
                  "additionalProperties": false
              },
              {
                "type": "object",
                "properties": {
                  "type": { "type": "string" },
                  "groups_regex": { "type": "string", "format": "regex" }
                },
                "required": ["type", "groups_regex"],
                "additionalProperties": false
              },
              {
                "type": "object",
                "properties": {
                  "type": { "const": "public" }
                },
                "required": ["type"]
              }
            ]  
        },
        "template": {
            "type": "object",
            "properties": {
                "name": { "type": "string" },
                "option": { "type": "string" },
                "description": { "type": "string" }
            },
            "additionalProperties": false,
            "if":
            {
                "type": "array",
                "minItems": 2
            },
            "then": {
                "required": ["name", "option"]
            },
            "else": {
                "required": ["name"]
            }
        },
        "authorization_required": {
          "type": "object",
          "properties": {
            "pre_tasks": { 
              "type": "array", 
              "items": { 
                "type": "object",
                "properties": {
                  "action": { "type": "string" },
                  "args": { "type": "object" }
                },
                "additionalProperties": false
              } 
            }
          }
        }
    }
  }
}
  